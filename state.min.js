(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?module.exports=factory():typeof define==="function"&&define.amd?define(factory):global.state=factory()})(this,function(){"use strict";const History=function(initial=[]){this.push(...initial)};History.prototype=new Array;const clean=error=>{if(!error.stack)return new Error("Stack not available in "+navigator.userAgent);return error.stack.split("\n").slice(1).filter(one=>one).filter(trace=>!/^_____/.test(trace))};History.prototype.add=function(entry){this.push(Object.assign({},entry,{timestamp:(new Date).getTime(),stack:clean(new Error,entry.key==="length")},entry));return this};History.prototype.type=function(type){return new History(this.filter(one=>one.type===type))};History.prototype.key=function(key){const current=one=>{const keyLength=key.split(".").length;return one.key.split(".").slice(0,keyLength).join(".")===key};return new History(this.filter(current))};History.prototype.latest=function(ms=Infinity){return new History(this.filter(one=>(new Date).getTime()-one.time<ms))};var history=new History;const listeners={};const basicTypes=["boolean","number","null","undefined","string"];const _____getProxy=(stack=[])=>(target,property)=>{if(typeof property==="symbol"){return target[property]}if("_____history"===property){return history}if("_____listeners"===property){return listeners}const key=[...stack.map(one=>one.property),property].join(".");if(property in target){history.add({type:"read",key:key});return target[property]}if(/^\$/.test(property)){const key=[...stack.map(one=>one.property),property.slice(1)||"_____root"].join(".");const current=key.split(".").reduce((state,prop)=>state[prop],state);listeners[key]=listeners[key]||[];return(callback,def)=>{listeners[key].push(callback);if(!callback.setState){return callback(current)}return callback}}};const _____setProxy=(stack=[])=>(target,property,value)=>{if(/^\$/.test(property)){throw new Error("The keys that start by $ are reserved and should not be set manually.")}if(/^\_\_/.test(property)){throw new Error("The keys that start by __ (two underscores) are reserved and should not be set manually.")}const key=[...stack.map(one=>one.property),property].join(".");const type=typeof target[property]==="undefined"?"create":"update";history.add({type:type,key:key,value:value});target[property]=value;if(typeof window!=="undefined"&&"localStorage"in window){localStorage.setItem("_____state",JSON.stringify({time:Math.floor((new Date).getTime()/1e3),data:state}))}const proxify=(value,stack)=>{if(basicTypes.includes(typeof value)||value===null){return value}if(Array.isArray(value)){value=value.map((value,property,target)=>{return proxify(value,[...stack,{target:target,property:property,value:value}])})}if(/^\{/.test(JSON.stringify(value))){for(let property in value){const current={target:target,property:property,value:value[property]};value[property]=proxify(value[property],[...stack,current])}}return new Proxy(value,{get:_____getProxy(stack),set:_____setProxy(stack),deleteProperty:_____delProxy(stack)})};target[property]=proxify(value,[...stack,{target:target,property:property,value:value}]);[...stack,{target:target,property:property,value:value}].forEach((one,i,all)=>{const key=all.slice(0,i+1).map(one=>one.property).join(".");if(listeners[key]){const current=key.split(".").reduce((state,prop)=>state[prop],state);listeners[key].forEach(one=>{if(one&&one.setState){return one.setState({__state:Math.random()})}one(current)})}});if(listeners._____root){listeners._____root.forEach(one=>{if(one&&one.setState){return one.setState({__state:Math.random()})}one(state)})}return true};const _____delProxy=(stack=[])=>(target,property)=>{if(/^\$/.test(property)){throw new Error("The keys that start by $ are reserved and should not be set manually.")}if(/^\_\_/.test(property)){throw new Error("The keys that start by __ (two underscores) are reserved and should not be set manually.")}const key=[...stack.map(one=>one.property),property].join(".");history.add({type:"delete",key:key});delete target[property];if(typeof window!=="undefined"&&"localStorage"in window){localStorage.setItem("_____state",JSON.stringify({time:Math.floor((new Date).getTime()/1e3),data:state}))}[...stack,{target:target,property:property}].forEach((one,i,all)=>{const key=all.slice(0,i+1).map(one=>one.property).join(".");if(listeners[key]){const current=key.split(".").reduce((state,prop)=>state[prop],state);listeners[key].forEach(one=>one(current))}});return true};const state=new Proxy({},{get:_____getProxy(),set:_____setProxy(),deleteProperty:_____delProxy()});if(typeof window!=="undefined"&&"localStorage"in window){const stored=JSON.parse(localStorage.getItem("_____state")||"{}");if(stored&&stored.data){for(let key in stored.data){state[key]=stored.data[key]}}}return state});